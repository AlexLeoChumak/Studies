<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset=utf-8>
    <title>Practical task â„–22 (ping-pong CANVAS)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
         body {
            width: 620px;
            padding: 0;
            margin: 10px auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 30px;
        }
        .score {
            font-size: 80px;
            border: 2px gray solid;
            margin: 20px auto;
            text-align: center;
        }
        .startBtn {
			margin: 10px auto;
			width: 620px;
			height: 200px;
            font-size: 80px;
            background: url(https://lh3.googleusercontent.com/SpmdtzgFJhiH8tU3tsm4uBpRxdgVessEEif7RV6M1DwB7gEOW_lNB5L91QfejnJTI7E=s180) left center no-repeat, 
                        url(https://lh3.googleusercontent.com/SpmdtzgFJhiH8tU3tsm4uBpRxdgVessEEif7RV6M1DwB7gEOW_lNB5L91QfejnJTI7E=s180) right center no-repeat;
        }
        #game {
            display: block;
        }
    </style>
</head>
<body>
    <canvas width="620" height="400" id="game"></canvas>

	<script>
        'use strict';

		const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const grid = 15;
        const racketHeight = grid * 5;
        const maxRacketY = canvas.height - grid - racketHeight;
        let racketSpeed = 6;
        let ballSpeed = 5;

        const startBtn = document.createElement('button');
        startBtn.type = 'button';
		startBtn.innerHTML = 'START'; 
		startBtn.classList.add('startBtn');
		document.body.prepend(startBtn);
		startBtn.addEventListener('click', start);

        const score = document.createElement('div');
        score.classList.add('score');
        document.body.prepend(score);
        let scoreLeft = 0;
        let scoreRight = 0;

        scoreBoardInnerHTML();
        function scoreBoardInnerHTML() {
			score.innerHTML = `${scoreLeft} : ${scoreRight}`;
		}

        const leftRacket = {
            x: 0,
            y: canvas.height / 2 - racketHeight / 2,
            width: grid,
            height: racketHeight,
            dy: 0,
        };

        const rightRacket = {
            x: canvas.width - grid,
            y: canvas.height / 2 - racketHeight / 2,
            width: grid,
            height: racketHeight,
            dy: 0,
        };

        const ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            width: grid,
            height: grid,
            radius: 7.5,
            resetting: false,
            dx: ballSpeed,
            dy: -ballSpeed,
        };

        function collides(obj1, obj2) {
             return obj1.x < obj2.x + obj2.width &&
                    obj1.x + obj1.width > obj2.x &&
                    obj1.y < obj2.y + obj2.height &&
                    obj1.y + obj1.height > obj2.y;
        }

        function start() {
            startBtn.remove();
            requestAnimationFrame(loop);
        }

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            leftRacket.y += leftRacket.dy;
            rightRacket.y += rightRacket.dy;

            if (leftRacket.y < grid) {
                leftRacket.y = grid;
            } else if (leftRacket.y > maxRacketY) {
                leftRacket.y = maxRacketY;
            }

            if (rightRacket.y < grid) {
                rightRacket.y = grid;
            } else if (rightRacket.y > maxRacketY) {
                rightRacket.y = maxRacketY;
            }

            ctx.fillStyle = 'red';
            ctx.fillRect(leftRacket.x, leftRacket.y, leftRacket.width, leftRacket.height);
            ctx.fillStyle = 'green';
            ctx.fillRect(rightRacket.x, rightRacket.y, rightRacket.width, rightRacket.height);

            ball.x += ball.dx;
            ball.y += ball.dy;

            if (ball.y < grid) {
                ball.y = grid;
                ball.dy *= -1;
            } else if (ball.y + grid > canvas.height - grid) {
                ball.y = canvas.height - grid * 2;
                ball.dy *= -1; 
            } 

            if ((ball.x < 0) && !ball.resetting) {
                ball.resetting = true;
                scoreRight++;
                scoreBoardInnerHTML();

                if (scoreRight > 4) {
                    score.remove();
                    scoreLeft--;
                    document.body.innerHTML = `<div class="winner">GAME OVER!<br> Winner - the player with the green racket!</div>`;
                    setTimeout(() => {location.reload()}, 3000);
                }

                setTimeout(() => {
                    ball.resetting = false;
                    ball.x = canvas.width / 2;
                    ball.y = canvas.height / 2;
                }, 2000);
            }

            if ((ball.x > canvas.width) && !ball.resetting) {
                ball.resetting = true;
                scoreLeft++;
                scoreBoardInnerHTML();

                if (scoreLeft > 4) {
                    score.remove();
                    scoreRight--;
                    document.body.innerHTML = `<div class="winner">GAME OVER!<br> Winner - the player with the red racket!</div>`;
                    setTimeout(() => {location.reload()}, 3000);
                }
                
                setTimeout(() => {
                    ball.resetting = false;
                    ball.x = canvas.width / 2;
                    ball.y = canvas.height / 2;
                }, 2000);
            }

            if (collides(ball, leftRacket)) {
                ball.dx *= -1;
                ball.x = leftRacket.x + leftRacket.width;
            } else if (collides(ball, rightRacket)) {
                ball.dx *= -1;
                ball.x = rightRacket.x - ball.width / 1.5;
            }

            ctx.fillStyle = 'rgb(255, 0, 225)';
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, Math.PI*2, false);
            ctx.stroke();
            ctx.fill();

            ctx.fillStyle = 'grey';
            ctx.fillRect(0, 0, canvas.width, grid);
            ctx.fillRect(0, canvas.height - grid, canvas.width, canvas.height);
            ctx.fillRect(0, 0, 1, canvas.height);
            ctx.fillRect(canvas.width - 1, 0, 1, canvas.height);

            for (let i = grid; i < canvas.height - grid; i += grid * 2) {
                ctx.fillRect(canvas.width / 2 - grid / 2, i, grid / 2, grid);
            }

            document.addEventListener('keydown', function(e) {
                if (e.which === 38) {
                    rightRacket.dy = -racketSpeed;
                } else if (e.which === 40) {
                    rightRacket.dy = racketSpeed;
                }

                if (e.which === 16) {
                    leftRacket.dy = -racketSpeed;
                } else if (e.which === 17) {
                    leftRacket.dy = racketSpeed;
                }
            });

            document.addEventListener('keyup', function(e) {
                if (e.which === 38 || e.which === 40) {
                    rightRacket.dy = 0;
                }
                if (e.which === 16 || e.which === 17) {
                    leftRacket.dy = 0;
                } 
            });

            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>